name: Create Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # Trigger on tags that match semantic versioning format (v0.0.1)

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for changelog generation
      
      - name: Get version from tag
        id: get_version
        run: |
          # Extract tag name (e.g., v1.0.0)
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_ENV
          
          # Extract version without 'v' prefix (e.g., 1.0.0)
          VERSION=${TAG#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "Tag: $TAG"
          echo "Version: $VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ env.TAG }}^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # If there's no previous tag, get all commits
            echo "CHANGELOG<<EOF" >> $GITHUB_ENV
            git log --pretty=format:"- %s (%h)" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            # Get commits between tags
            echo "CHANGELOG<<EOF" >> $GITHUB_ENV
            git log --pretty=format:"- %s (%h)" $PREV_TAG..${{ env.TAG }} >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          body: |
            # Trivy UI Release ${{ env.TAG }}
            
            ## Changes
            ${{ env.CHANGELOG }}
            
            ## Installation
            
            ### Docker
            ```bash
            docker pull locustbaby/trivy-ui:${{ env.TAG }}
            docker run -v ~/.kube:/root/.kube -p 8080:8080 locustbaby/trivy-ui:${{ env.TAG }}
            ```
            
            ### Manual Installation
            1. Clone the repository
            2. Build the frontend: `cd trivy-dashboard && npm install && npm run build`
            3. Build the backend: `cd go-server && go build`
            4. Run the server: `./go-server`
          draft: false
          prerelease: false
          generate_release_notes: true
