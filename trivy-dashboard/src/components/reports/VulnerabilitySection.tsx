import { useState, useMemo, useCallback } from "react"
import { Button } from "../ui/button"
import { Search, ChevronDown, ChevronUp, ExternalLink, ChevronsUpDown, Copy, Check } from "lucide-react"
import {
  getSeverityColor,
  getSeverityBgColor,
  getSeverityBadgeColor,
  parseSafeUrl,
} from "../../lib/severity"

interface Vulnerability {
  vulnerabilityID?: string
  id?: string
  title?: string
  description?: string
  severity?: string
  resource?: string
  packageName?: string
  installedVersion?: string
  fixedVersion?: string
  primaryLink?: string
  links?: string[]
  score?: number
  cvss?: {
    nvd?: {
      V3Score?: number
      V2Score?: number
    }
  }
  publishedDate?: string
  lastModifiedDate?: string
}

interface VulnerabilitySectionProps {
  vulnerabilities: Vulnerability[]
}

export function VulnerabilitySection({ vulnerabilities }: VulnerabilitySectionProps) {
  const [searchQuery, setSearchQuery] = useState("")
  const [severityFilter, setSeverityFilter] = useState<string>("all")
  const [expandedCVE, setExpandedCVE] = useState<string | null>(null)
  const [expandAll, setExpandAll] = useState(false)
  const [copiedField, setCopiedField] = useState<string | null>(null)

  const copyToClipboard = useCallback((text: string, fieldId: string, e: React.MouseEvent) => {
    e.stopPropagation()
    navigator.clipboard
      .writeText(text)
      .then(() => {
        setCopiedField(fieldId)
        setTimeout(() => setCopiedField(null), 1500)
      })
      .catch((err) => {
        console.error("Failed to copy:", err)
      })
  }, [])

  const filteredVulnerabilities = useMemo(() => {
    let filtered = vulnerabilities

    if (severityFilter !== "all") {
      filtered = filtered.filter(
        (v) => (v.severity || "").toLowerCase() === severityFilter.toLowerCase()
      )
    }

    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase()
      filtered = filtered.filter((v) => {
        const cveId = (v.vulnerabilityID || v.id || "").toLowerCase()
        const title = (v.title || "").toLowerCase()
        const resource = (v.resource || v.packageName || "").toLowerCase()
        return cveId.includes(query) || title.includes(query) || resource.includes(query)
      })
    }

    return filtered
  }, [vulnerabilities, severityFilter, searchQuery])

  const vulnerabilitiesBySeverity = useMemo(() => {
    const grouped: Record<string, Vulnerability[]> = {
      CRITICAL: [],
      HIGH: [],
      MEDIUM: [],
      LOW: [],
      UNKNOWN: [],
    }

    filteredVulnerabilities.forEach((v) => {
      const severity = (v.severity || "UNKNOWN").toUpperCase()
      if (grouped[severity]) {
        grouped[severity].push(v)
      } else {
        grouped.UNKNOWN.push(v)
      }
    })

    return grouped
  }, [filteredVulnerabilities])

  const handleToggle = (cveId: string) => {
    if (expandAll) {
      setExpandAll(false)
      setExpandedCVE(cveId)
    } else {
      setExpandedCVE(expandedCVE === cveId ? null : cveId)
    }
  }

  const isExpanded = (cveId: string) => {
    return expandAll || expandedCVE === cveId
  }

  if (vulnerabilities.length === 0) {
    return (
      <div className="rounded-xl border bg-card p-5">
        <h3 className="text-base font-semibold flex items-center gap-2 mb-4">
          <svg
            className="h-5 w-5 text-primary"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
          Vulnerabilities
        </h3>
        <div className="text-sm text-muted-foreground py-8 text-center bg-muted/30 rounded-lg">
          <svg
            className="h-12 w-12 mx-auto mb-3 text-green-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          No vulnerabilities found
        </div>
      </div>
    )
  }

  return (
    <div className="rounded-xl border bg-card p-5">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-base font-semibold flex items-center gap-2">
          <svg
            className="h-5 w-5 text-primary"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
          Vulnerabilities
          <span className="ml-2 text-xs text-muted-foreground font-normal px-2 py-0.5 bg-muted rounded-full">
            {filteredVulnerabilities.length} / {vulnerabilities.length}
          </span>
        </h3>
        <Button
          variant="outline"
          size="sm"
          onClick={() => setExpandAll(!expandAll)}
          className="gap-1.5"
        >
          <ChevronsUpDown className="h-4 w-4" />
          {expandAll ? "Collapse All" : "Expand All"}
        </Button>
      </div>

      {/* Filters */}
      <div className="flex gap-3 mb-4 flex-col sm:flex-row">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none" />
          <input
            type="text"
            placeholder="Search CVE ID, title, or package..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full pl-9 pr-4 h-9 text-sm rounded-lg border border-input bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50"
          />
        </div>
        <div className="flex gap-1 flex-wrap">
          {["all", "CRITICAL", "HIGH", "MEDIUM", "LOW"].map((sev) => (
            <Button
              key={sev}
              variant={severityFilter === sev ? "default" : "outline"}
              size="sm"
              onClick={() => setSeverityFilter(sev)}
              className="h-9 text-xs px-3"
            >
              {sev === "all" ? "All" : sev}
            </Button>
          ))}
        </div>
      </div>

      {/* Vulnerabilities List */}
      <div className="space-y-4 max-h-[500px] overflow-y-auto scrollbar-thin pr-1">
        {Object.entries(vulnerabilitiesBySeverity).map(([severity, vulns]) => {
          if (vulns.length === 0) return null

          return (
            <div key={severity} className="space-y-2">
              <div
                className={`flex items-center justify-between px-3 py-2 rounded-lg ${getSeverityBgColor(severity)}`}
              >
                <span className={`text-sm font-semibold ${getSeverityColor(severity)}`}>
                  {severity} ({vulns.length})
                </span>
              </div>
              <div className="space-y-2">
                {vulns.map((vuln, index) => {
                  const cveId = vuln.vulnerabilityID || vuln.id || `VULN-${severity}-${index}`
                  const expanded = isExpanded(cveId)
                  const cvssScore =
                    vuln.score || vuln.cvss?.nvd?.V3Score || vuln.cvss?.nvd?.V2Score || null
                  const resource = vuln.resource || vuln.packageName || "Unknown"
                  const installedVersion = vuln.installedVersion || "N/A"
                  const fixedVersion = vuln.fixedVersion || "Not available"

                  return (
                    <div
                      key={cveId}
                      className={`border rounded-lg p-3 ${getSeverityBgColor(vuln.severity || "unknown")} cursor-pointer hover:shadow-md transition-all duration-200`}
                      onClick={() => handleToggle(cveId)}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1.5 flex-wrap">
                            <button
                              onClick={(e) => copyToClipboard(cveId, `cve-${cveId}`, e)}
                              className="group inline-flex items-center gap-1 font-semibold text-sm hover:text-primary transition-colors"
                              title="Click to copy CVE ID"
                            >
                              <span className={copiedField === `cve-${cveId}` ? "text-green-500" : ""}>{cveId}</span>
                              {copiedField === `cve-${cveId}` ? (
                                <Check className="h-3 w-3 text-green-500" />
                              ) : (
                                <Copy className="h-3 w-3 opacity-0 group-hover:opacity-50" />
                              )}
                            </button>
                            {vuln.primaryLink && (
                              <a
                                href={vuln.primaryLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                onClick={(e) => e.stopPropagation()}
                                className="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-primary bg-primary/10 hover:bg-primary/20 rounded-md transition-colors"
                              >
                                <ExternalLink className="h-3 w-3" />
                                View CVE
                              </a>
                            )}
                            {cvssScore && (
                              <span
                                className={`text-xs font-medium px-2 py-0.5 rounded-full ${getSeverityBadgeColor(vuln.severity || "")}`}
                              >
                                CVSS: {cvssScore}
                              </span>
                            )}
                          </div>
                          {vuln.title && (
                            <div className="text-sm text-foreground mb-2 line-clamp-1">
                              {vuln.title}
                            </div>
                          )}
                          <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground">
                            <button
                              onClick={(e) => copyToClipboard(resource, `pkg-${cveId}`, e)}
                              className="group inline-flex items-center gap-1 hover:text-foreground transition-colors"
                              title="Click to copy package name"
                            >
                              <span className="font-medium">Package: </span>
                              <span className={`font-mono ${copiedField === `pkg-${cveId}` ? "text-green-500" : ""}`}>{resource}</span>
                              {copiedField === `pkg-${cveId}` ? (
                                <Check className="h-3 w-3 text-green-500" />
                              ) : (
                                <Copy className="h-3 w-3 opacity-0 group-hover:opacity-50" />
                              )}
                            </button>
                            <button
                              onClick={(e) => copyToClipboard(installedVersion, `ver-${cveId}`, e)}
                              className="group inline-flex items-center gap-1 hover:text-foreground transition-colors"
                              title="Click to copy version"
                            >
                              <span className="font-medium">Installed: </span>
                              <span className={`font-mono ${copiedField === `ver-${cveId}` ? "text-green-500" : ""}`}>{installedVersion}</span>
                              {copiedField === `ver-${cveId}` ? (
                                <Check className="h-3 w-3 text-green-500" />
                              ) : (
                                <Copy className="h-3 w-3 opacity-0 group-hover:opacity-50" />
                              )}
                            </button>
                            {fixedVersion !== "Not available" && (
                              <button
                                onClick={(e) => copyToClipboard(fixedVersion, `fix-${cveId}`, e)}
                                className="group inline-flex items-center gap-1 hover:text-foreground transition-colors"
                                title="Click to copy fixed version"
                              >
                                <span className="font-medium">Fixed: </span>
                                <span className={`font-mono ${copiedField === `fix-${cveId}` ? "text-green-500" : "text-green-600 dark:text-green-400"}`}>
                                  {fixedVersion}
                                </span>
                                {copiedField === `fix-${cveId}` ? (
                                  <Check className="h-3 w-3 text-green-500" />
                                ) : (
                                  <Copy className="h-3 w-3 opacity-0 group-hover:opacity-50" />
                                )}
                              </button>
                            )}
                          </div>
                        </div>
                        <button className="ml-3 flex-shrink-0 p-1 rounded hover:bg-black/5 dark:hover:bg-white/5">
                          {expanded ? (
                            <ChevronUp className="h-4 w-4 text-muted-foreground" />
                          ) : (
                            <ChevronDown className="h-4 w-4 text-muted-foreground" />
                          )}
                        </button>
                      </div>

                      {expanded && (
                        <div className="mt-3 pt-3 border-t space-y-3">
                          {vuln.description && (
                            <div className="text-sm text-muted-foreground leading-relaxed">
                              {vuln.description}
                            </div>
                          )}

                          <div className="grid grid-cols-2 gap-3 text-xs">
                            {vuln.publishedDate && (
                              <div>
                                <span className="text-muted-foreground">Published: </span>
                                <span>
                                  {new Date(vuln.publishedDate).toLocaleDateString()}
                                </span>
                              </div>
                            )}
                            {vuln.lastModifiedDate && (
                              <div>
                                <span className="text-muted-foreground">Modified: </span>
                                <span>
                                  {new Date(vuln.lastModifiedDate).toLocaleDateString()}
                                </span>
                              </div>
                            )}
                          </div>

                          {vuln.cvss?.nvd && (
                            <div className="text-xs">
                              <div className="font-medium text-muted-foreground mb-1">
                                CVSS Scores:
                              </div>
                              <div className="flex gap-4">
                                {vuln.cvss.nvd.V3Score && (
                                  <span className="px-2 py-1 bg-muted rounded">
                                    v3.1:{" "}
                                    <span className="font-semibold">
                                      {vuln.cvss.nvd.V3Score}
                                    </span>
                                  </span>
                                )}
                                {vuln.cvss.nvd.V2Score && (
                                  <span className="px-2 py-1 bg-muted rounded">
                                    v2.0:{" "}
                                    <span className="font-semibold">
                                      {vuln.cvss.nvd.V2Score}
                                    </span>
                                  </span>
                                )}
                              </div>
                            </div>
                          )}

                          {vuln.links && Array.isArray(vuln.links) && vuln.links.length > 0 && (
                            <div className="text-xs">
                              <div className="font-medium text-muted-foreground mb-2">
                                References:
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {vuln.links.slice(0, 5).map((link, linkIndex) => {
                                  const parsedUrl = parseSafeUrl(link)
                                  return (
                                    <a
                                      key={linkIndex}
                                      href={link}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      onClick={(e) => e.stopPropagation()}
                                      className="inline-flex items-center gap-1 px-2 py-1 bg-muted hover:bg-muted/80 rounded text-primary hover:text-primary/80"
                                    >
                                      <ExternalLink className="h-3 w-3" />
                                      <span className="truncate max-w-[200px]">
                                        {parsedUrl?.hostname || link}
                                      </span>
                                    </a>
                                  )
                                })}
                                {vuln.links.length > 5 && (
                                  <span className="px-2 py-1 text-muted-foreground">
                                    +{vuln.links.length - 5} more
                                  </span>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          )
        })}
      </div>
    </div>
  )
}
