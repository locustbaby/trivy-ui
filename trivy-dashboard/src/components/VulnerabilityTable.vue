<template>
  <n-data-table
    v-if="reports.length"
    :columns="columns"
    :data="reports"
    :pagination="pagination"
    :bordered="true"
    striped
  />
  <div v-else class="no-data">
    No vulnerability reports found
  </div>
</template>

<script>
import { h, ref } from 'vue'
import { NButton, NDataTable } from 'naive-ui'
import { getVulnerabilityCount, formatDate } from '../utils/formatters'

export default {
  components: {
    NDataTable
  },
  props: {
    reports: {
      type: Array,
      default: () => []
    },
    pageSize: {
      type: Number,
      default: 10
    }
  },
  emits: ['view-details', 'update:pageSize'],
  setup(props, { emit }) {
    const pagination = ref({
      pageSize: props.pageSize,
      showSizePicker: true,
      pageSizes: [10, 20, 50, 100],
      onChange: (page) => {
        pagination.value.page = page
      },
      onUpdatePageSize: (pageSize) => {
        pagination.value.pageSize = pageSize
        emit('update:pageSize', pageSize)
      }
    })

    // Helper function to extract container name consistently
    function getContainerName(row) {
      return row.metadata?.labels?.['trivy-operator.container.name'] || 
             (row.metadata?.name || '').split('-').pop() || 
             'N/A'
    }

    const columns = [
      {
        title: 'Name',
        key: 'metadata.name',
        sorter: 'default'
      },
      {
        title: 'Container Name',
        key: 'containerName',
        sorter: (a, b) => {
          const nameA = getContainerName(a)
          const nameB = getContainerName(b)
          return nameA.localeCompare(nameB)
        },
        render: (row) => getContainerName(row)
      },
      {
        title: 'Namespace',
        key: 'metadata.namespace',
        sorter: 'default'
      },
      {
        title: 'Created',
        key: 'metadata.creationTimestamp',
        sorter: (a, b) => new Date(a.metadata.creationTimestamp) - new Date(b.metadata.creationTimestamp),
        render: (row) => formatDate(row.metadata.creationTimestamp)
      },
      {
        title: 'Resource',
        key: 'resource',
        render: (row) => {
          const kind = row.metadata?.labels?.['trivy-operator.resource.kind'] || 'Unknown'
          const name = row.metadata?.labels?.['trivy-operator.resource.name'] || 'Unknown'
          return `${kind}/${name}`
        }
      },
      {
        title: 'Critical',
        key: 'critical',
        sorter: (a, b) => getVulnerabilityCount(a, 'CRITICAL') - getVulnerabilityCount(b, 'CRITICAL'),
        render: (row) => getVulnerabilityCount(row, 'CRITICAL')
      },
      {
        title: 'High',
        key: 'high',
        sorter: (a, b) => getVulnerabilityCount(a, 'HIGH') - getVulnerabilityCount(b, 'HIGH'),
        render: (row) => getVulnerabilityCount(row, 'HIGH')
      },
      {
        title: 'Medium',
        key: 'medium',
        sorter: (a, b) => getVulnerabilityCount(a, 'MEDIUM') - getVulnerabilityCount(b, 'MEDIUM'),
        render: (row) => getVulnerabilityCount(row, 'MEDIUM')
      },
      {
        title: 'Low',
        key: 'low',
        sorter: (a, b) => getVulnerabilityCount(a, 'LOW') - getVulnerabilityCount(b, 'LOW'),
        render: (row) => getVulnerabilityCount(row, 'LOW')
      },
      {
        title: 'Details',
        key: 'details',
        render: (row) => h(NButton, {
          size: 'small',
          onClick: () => emit('view-details', row)
        }, { default: () => 'View Details' })
      }
    ]

    return {
      columns,
      pagination
    }
  }
}
</script>

<style scoped>
.no-data {
  padding: 20px;
  text-align: center;
  color: #999;
}
</style>