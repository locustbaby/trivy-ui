<template>
  <n-data-table
    v-if="reports.length"
    :columns="columns"
    :data="reports"
    :bordered="true"
    :pagination="pagination"
    striped
  />
  <div v-else class="no-data">
    No vulnerability reports found
  </div>
</template>

<script>
import { h, ref } from 'vue'
import { NButton, NDataTable } from 'naive-ui'
import { getVulnerabilityCount, formatDate } from '../utils/formatters'

export default {
  components: {
    NDataTable
  },
  props: {
    reports: {
      type: Array,
      default: () => []
    }
  },
  emits: ['view-details'],
  setup(props, { emit }) {
    // Add pagination control
    const pagination = ref({
      pageSize: 10,
      showSizePicker: true,
      pageSizes: [10, 20, 50, 100]
    })

    // Helper function to extract container name consistently
    function getContainerName(row) {
      return row.metadata?.labels?.['trivy-operator.container.name'] || 
             (row.metadata?.name || '').split('-').pop() || 
             'N/A'
    }

    const columns = [
      {
        title: 'Cluster',
        key: 'cluster',
        sorter: (a, b) => {
          const clusterA = a.cluster || '';
          const clusterB = b.cluster || '';
          return clusterA.localeCompare(clusterB);
        },
        render: (row) => {
          const clusterName = row.metadata?.labels?.['trivy-operator.cluster.name'] || 
                            row.metadata?.labels?.['trivy-operator.cluster'] || 
                            row.cluster || 
                            'N/A';
          return h('div', {
            style: {
              color: '#333',
              fontWeight: 'normal'
            }
          }, clusterName)
        }
      },
      {
        title: 'Name',
        key: 'name',
        sorter: 'default'
      },
      {
        title: 'Container Name',
        key: 'containerName',
        sorter: (a, b) => {
          const nameA = getContainerName(a)
          const nameB = getContainerName(b)
          return nameA.localeCompare(nameB)
        },
        render: (row) => getContainerName(row)
      },
      {
        title: 'Namespace',
        key: 'namespace',
        sorter: 'default'
      },
      {
        title: 'Created',
        key: 'created_at',
        sorter: (a, b) => new Date(a.created_at) - new Date(b.created_at),
        render: (row) => formatDate(row.created_at)
      },
      {
        title: 'Resource',
        key: 'resource',
        render: (row) => {
          const kind = row.metadata?.labels?.['trivy-operator.resource.kind'] || 'Unknown'
          const name = row.metadata?.labels?.['trivy-operator.resource.name'] || 'Unknown'
          return `${kind}/${name}`
        }
      },
      {
        title: 'Critical',
        key: 'critical',
        sorter: (a, b) => getVulnerabilityCount(a, 'CRITICAL') - getVulnerabilityCount(b, 'CRITICAL'),
        render: (row) => h('span', { 
          style: { 
            color: getVulnerabilityCount(row, 'CRITICAL') > 0 ? '#ff4d4f' : '#999',
            fontWeight: getVulnerabilityCount(row, 'CRITICAL') > 0 ? '500' : 'normal'
          } 
        }, getVulnerabilityCount(row, 'CRITICAL'))
      },
      {
        title: 'High',
        key: 'high',
        sorter: (a, b) => getVulnerabilityCount(a, 'HIGH') - getVulnerabilityCount(b, 'HIGH'),
        render: (row) => h('span', { 
          style: { 
            color: getVulnerabilityCount(row, 'HIGH') > 0 ? '#faad14' : '#999',
            fontWeight: getVulnerabilityCount(row, 'HIGH') > 0 ? '500' : 'normal'
          } 
        }, getVulnerabilityCount(row, 'HIGH'))
      },
      {
        title: 'Medium',
        key: 'medium',
        sorter: (a, b) => getVulnerabilityCount(a, 'MEDIUM') - getVulnerabilityCount(b, 'MEDIUM'),
        render: (row) => h('span', { 
          style: { 
            color: getVulnerabilityCount(row, 'MEDIUM') > 0 ? '#1890ff' : '#999',
            fontWeight: getVulnerabilityCount(row, 'MEDIUM') > 0 ? '500' : 'normal'
          } 
        }, getVulnerabilityCount(row, 'MEDIUM'))
      },
      {
        title: 'Low',
        key: 'low',
        sorter: (a, b) => getVulnerabilityCount(a, 'LOW') - getVulnerabilityCount(b, 'LOW'),
        render: (row) => h('span', { 
          style: { 
            color: getVulnerabilityCount(row, 'LOW') > 0 ? '#52c41a' : '#999',
            fontWeight: getVulnerabilityCount(row, 'LOW') > 0 ? '500' : 'normal'
          } 
        }, getVulnerabilityCount(row, 'LOW'))
      },
      {
        title: 'Details',
        key: 'details',
        render: (row) => h(NButton, {
          size: 'small',
          onClick: () => emit('view-details', row)
        }, { default: () => 'View Details' })
      }
    ]

    return {
      columns,
      pagination
    }
  }
}
</script>

<style scoped>
.no-data {
  padding: 20px;
  text-align: center;
  color: #999;
}
</style>